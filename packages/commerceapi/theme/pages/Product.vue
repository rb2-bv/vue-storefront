<template>
  <div id="product">
    <SfBreadcrumbs
      class="breadcrumbs desktop-only"
      :breadcrumbs="breadcrumbs"
      @click="pushRoute"
    />
    <div class="product">
      <div class="product__gallery">
        <SfGallery
          class="gallery"
          :images="images"
        />        
      </div>
      <div class="product__description">
        <SfSticky class="product-details">
          <SfHeading
            :title="productGetters.getName(product)"
            :level="1"
            class="sf-heading--no-underline sf-heading--left product-details__heading"
          />
          <div class="product-details__sub">
            <SfPrice
              :regular="productGetters.getFormattedPrice(productGetters.getPrice(product).regular)"
              :special="productGetters.getFormattedPrice(productGetters.getPrice(product).special)"
            />
            <div class="product-details__sub-rating">
              <SfRating :score="productGetters.getReviewDetails(product).score" :max="5" />
              <div class="product-details__sub-reviews desktop-only">
                <SfButton class="sf-button--text color-secondary" @click="showReviews">Read all {{productGetters.getReviewDetails(product).count}} review(s).</SfButton>
              </div>
              <div class="product-details__sub-reviews mobile-only">
                ({{productGetters.getReviewDetails(product).count}})
              </div>
            </div>
          </div>
          <div class="product-details__description desktop-only" v-html="$md.render(productGetters.getProductSummary(product))">
          </div>
          <div class="product-details__action">
<!-- size guide was here. -->
          </div>
          <!-- TODO: add size selector after design is added -->
          <div class="product-details__section desktop-only" >
            <SfSelect
              v-if="options.size"
              :selected="configuration.size"
              @change="size => updateFilter({ size })"
              label="Size"
              class="sf-select--underlined product-details__attribute"
            >
              <SfSelectOption
                v-for="size in options.size"
                :key="size.value"
                :value="size.value"
              >
                <SfProductOption :label="size.label" />
              </SfSelectOption>
            </SfSelect>
            <SfSelect
              v-if="options.color"
              :selected="configuration.color"
              @change="color => updateFilter({ color })"
              label="Color"
              class="sf-select--bordered product-details__attribute"
            >
              <SfSelectOption
                v-for="color in options.color"
                :key="color.value"
                :value="color.value"
              >
                <SfProductOption :label="color.label" />
              </SfSelectOption>
            </SfSelect>
          </div>
          <div class="product-details__section">
            <SfAlert
              message="Low in stock"
              type="warning"
              class="product-details__alert mobile-only"
            />
            <SfAddToCart
              :stock="stock"
              v-model="qty"
              :disabled="loading"
              :canAddToCart="stock > 0"
              @click="addToCart(product, parseInt(qty))"
              class="product-details__add-to-cart"
            />
            <div class="product-details__action">
              <SfButton class="sf-button--text color-secondary"
                >Save for later</SfButton
              >
            </div>
            <div class="product-details__action">
              <SfButton class="sf-button--text color-secondary"
                >Add to compare</SfButton
              >
            </div>
          </div>
          <SfTabs class="product-details__tabs" ref="productDetailTabs">
            <SfTab title="Description">
              <div>
                <div v-html="$md.render(description)"></div>
              </div>
            </SfTab>
            <SfTab title="Read reviews">
              <SfReview
                class="product-details__review"
                v-for="(review, i) in reviews.reviews.value"
                :key="i"
                :author="review.author"
                :date="review.date"
                :message="review.message"
                :rating="review.rating"
                :max-rating="5"
              />
            </SfTab>
            <SfTab title="Additional Information">
              <SfHeading
                title="Properties"
                :level="3"
                class="sf-heading--no-underline sf-heading--left"
              />
                <div class="product-details__properties">
                  <SfProperty
                    v-for="(property, i) in properties"
                    :key="i"
                    :name="property.name"
                    :value="property.value"
                    class="product-property"
                  />
                </div>
            </SfTab>
          </SfTabs>
        </SfSticky>
      </div>
    </div>
    <RelatedProducts
      :products="relatedProducts"
      :loading="relatedLoading"
      title="Match it with"
    />
    <InstagramFeed />
    <SfBanner
      image="/homepage/bannerD.png"
      subtitle="Fashion to Take Away"
      title="Download our application to your mobile"
      class="sf-banner--left desktop-only banner-app"
    >
      <template #call-to-action>
        <div class="banner-app__call-to-action">
          <SfImage
            class="banner-app__image"
            src="/homepage/google.png"
            :width="191"
            :height="51"
            alt="Google Play"
          />
          <SfImage
            class="banner-app__image"
            src="/homepage/apple.png"
            :width="174"
            :height="57"
            alt="App Store"
          />
        </div>
      </template>
    </SfBanner>
  </div>
</template>
<script>
import {
  SfProperty,
  SfHeading,
  SfPrice,
  SfRating,
  SfSelect,
  SfProductOption,
  SfAddToCart,
  SfTabs,
  SfGallery,
  SfImage,
  SfBanner,
  SfAlert,
  SfSticky,
  SfReview,
  SfBreadcrumbs,
  SfButton,
  SfColor
} from '@storefront-ui/vue';

import InstagramFeed from '~/components/InstagramFeed.vue';
import RelatedProducts from '~/components/RelatedProducts.vue';
import { ref, computed, watch } from '@vue/composition-api';
import { useProduct, useCart, productGetters, useReviews, reviewGetters } from '@vue-storefront/commerceapi';
import { onSSR } from '@vue-storefront/core';

export default {
  name: 'Product',
  transition: 'fade',
  setup(props, context) {
    const qty = ref(1);
    const { id } = context.root.$route.params;
    const { products, search } = useProduct('products');
    const { products: relatedProducts, search: searchRelatedProducts, loading: relatedLoading } = useProduct('relatedProducts');
    const { addToCart, loading } = useCart();

    const product = computed(() => productGetters.getFiltered(products.value, { master: true, attributes: context.root.$route.query })[0]);
    const options = computed(() => productGetters.getAttributes(product.value, ['color', 'size']));
    const configuration = computed(() => productGetters.getAttributes(product.value, ['color', 'size']));
    const properties = computed(() => productGetters.getProperties(product.value));
    const categories = computed(() => productGetters.getCategoryIds(product.value));
    const description = computed(() => productGetters.getDescription(product.value));
    const breadcrumbs = computed(() => productGetters.getBreadcrumbs(product.value));
    const reviews = useReviews();
    const images = computed(() => productGetters.getGallery(product.value).map(
      a => {
        return {
          alt: productGetters.getDescription(product.value),
          mobile: {url: a.small},
          desktop: {url: a.normal},
          zoom: {url: a.big}
        }
      }));

    watch(product, () => {
      reviews.loadProduct(product.value);
    })    

    onSSR(async () => {
      await search({ id });
      await searchRelatedProducts({ catId: [categories.value[0]] });
    });

    const updateFilter = (filter) => {
      context.root.$router.push({
        path: context.root.$route.path,
        query: { ...configuration.value,
          ...filter }
      });
    };

    function pushRoute(r)
    {
      context.root.$router.push({path: r.link})
    }

    function showReviews() {
      context.refs.productDetailTabs.toggle(context.refs.productDetailTabs.$children[1]._uid);
      context.refs.productDetailTabs.$el?.scrollIntoView();
    }

    return {
      updateFilter,
      configuration,
      properties,
      product,
      relatedProducts,
      relatedLoading,
      options,
      qty,
      addToCart,
      loading,
      productGetters,
      description,
      breadcrumbs,
      pushRoute,
      showReviews,
      reviews,
      images
    };
  },
  components: {
    SfAlert,
    SfProperty,
    SfHeading,
    SfPrice,
    SfRating,
    SfSelect,
    SfProductOption,
    SfAddToCart,
    SfTabs,
    SfGallery,
    SfImage,
    SfBanner,
    SfSticky,
    SfReview,
    SfBreadcrumbs,
    SfButton,
    InstagramFeed,
    RelatedProducts
  },
  data() {
    return {
      stock: 5
    };
  }
};
</script>
<style lang="scss" scoped>
@import "~@storefront-ui/vue/styles";
#product {
  box-sizing: border-box;
  @include for-desktop {
    max-width: 1240px;
    margin: 0 auto;
  }
}
.section {
  padding: 0 var(--spacer-xl);
  @include for-desktop {
    padding: 0;
  }
}
.breadcrumbs {
  margin: var(--spacer-base) auto var(--spacer-lg);
}
.product {
  @include for-desktop {
    display: flex;
  }
  &__gallery,
  &__description {
    flex: 1;
  }
  &__description {
    padding: 0 var(--spacer-sm);
    @include for-desktop {
      padding: 0;
      margin: 0 0 0 calc(var(--spacer-xl) * 5);
    }
  }
}
.product-property {
  margin: var(--spacer-xs) 0;
}
.product-details {
  &__heading {
    margin: var(--spacer-lg) 0 0 0;
    @include for-desktop {
      margin: var(--spacer-base) 0;
    }
  }
  &__sub {
    @include for-desktop {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
  }
  &__sub-rating {
    display: flex;
    align-items: center;
    margin: var(--spacer-sm) 0 0 0;
    @include for-desktop {
      flex-direction: column;
      align-items:flex-start;
      margin: 0;
    }
  }
    &__colors {
    @include font(
      --product-color-font,
      var(--font-normal),
      var(--font-lg),
      1.6,
      var(--font-family-secondary)
    );
    display: flex;
    align-items: center;
    margin-top: var(--spacer-xl);
  }
  &__color-label {
    margin: 0 var(--spacer-lg) 0 0;
  }
  &__color {
    margin: 0 var(--spacer-2xs);
  }
  &__sub-reviews {
    margin: var(--spacer-2xs) 0 0 0;
    font-size: var(--font-xs);
  }
  &__section {
    border: 1px solid var(--c-light);
    border-width: 0 0 1px 0;
    padding: 0 0 0.625rem 0;
    @include for-desktop {
      border: 0;
      padding: 0;
    }
  }
  &__action {
    display: flex;
    &:not(:last-of-type) {
      margin: var(--spacer-xl) 0 var(--spacer-base);
    }
    @include for-desktop {
      justify-content: flex-end;
    }
  }
  &__add-to-cart {
    margin: var(--spacer-base) 0 0 0;
    @include for-desktop {
      margin: var(--spacer-2xl) 0 0 0;
    }
  }
  &__alert {
    margin: var(--spacer-base) 0 0 0;
  }
  &__attribute {
    margin: 0 0 var(--spacer-xl) 0;
  }
  &__description {
    margin: var(--spacer-xl) 0;
    font-family: var(--font-family-secondary);
    font-size: var(--font-base);
    color: var(--c-dark-variant);
    line-height: 1.6;
    @include for-desktop {
      font-size: var(--font-base);
    }
  }
  &__properties {
    margin: var(--spacer-xl) 0 0 0;
  }
  &__tabs {
    --tabs-title-padding: var(--spacer-sm) 0;
    --tabs-content-tab-padding: var(--spacer-sm) 0;
    margin: var(--spacer-lg) 0 0 0;
    @include for-desktop {
      margin-top: var(--spacer-2xl);
    }
  }
  &__review {
    padding: var(--spacer-xl) 0;
    border: 1px solid var(--c-light);
    border-width: 0 0 1px 0;
  }
}
.product-carousel {
  margin: 0 calc(var(--spacer-xl) * -1) 0 0;
  @include for-desktop {
    margin: var(--spacer-xl) 0;
    --carousel-padding: var(--spacer-xl);
    --carousel-max-width: calc(100% - 13.5rem);
  }
}
.product-card {
  &:hover {
    --product-card-box-shadow: 0 4px 20px rgba(168, 172, 176, 0.19);
  }
}
.images-grid {
  max-width: 60rem;
  margin: 0 auto;
  &__row {
    display: flex;
    & + & {
      margin: calc(var(--spacer-xl) / 2) 0 0 0;
      @include for-desktop {
        margin: var(--spacer-xl) 0 0 0;
      }
    }
  }
  &__col {
    flex: 1;
    margin: 0;
    & + & {
      margin: 0 0 0 calc(var(--spacer-xl) / 2);
      @include for-desktop {
        margin: 0 0 0 var(--spacer-xl);
      }
    }
  }
}
.banner-app {
  --banner-title-margin: var(--spacer-xl) 0 0 0;
  --banner-title-font-size: var(--h1-font-size);
  --banner-subtitle-font-size: var(--font-size-extra-big);
  min-height: 26.25rem;
  max-width: 65rem;
  margin: 0 auto;
  padding-right: calc(25% + 5rem);
  padding-left: 2.5rem;
  &__call-to-action {
    display: flex;
    margin: var(--space-big) 0 0 0;
  }
  &__image {
    width: 22%;
    & + & {
      margin: 0 0 0 var(--spacer-xl);
    }
  }
}
</style>
